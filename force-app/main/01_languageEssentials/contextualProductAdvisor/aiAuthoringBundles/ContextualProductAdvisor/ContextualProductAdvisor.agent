# ContextualProductAdvisor - Pre-flight Context Collection with Immediate Topic Transition
# Demonstrates the "intercept → collect → hand off" pattern:
#
#   Topic 1 — context_gate (start_agent)
#     The entry point. Never answers product questions directly.
#     Its sole job is to ask for company size and, the moment it is
#     provided, fire 'collect_employee_count' which stores the value
#     AND immediately transitions to the product_advisor topic.
#
#   Topic 2 — product_advisor
#     Receives control right after the number is stored.
#     Looks back at the conversation, finds the user's original
#     unanswered question, and answers it — and every follow-up —
#     tailored to the stored company size.
#
# Key mechanics:
#   • 'transition to @topic.product_advisor' on the collect action
#     means the hand-off is instant: no extra turn, no re-prompting.
#   • Variables are shared across topics, so number_of_employees is
#     immediately visible to product_advisor after it is set.
#   • The product_advisor topic has no way back to context_gate, so
#     company size is never asked again for the rest of the session.

config:
   agent_name: "ContextualProductAdvisor"
   agent_label: "ContextualProductAdvisor"
   agent_type: "AgentforceEmployeeAgent"
   description: "Collects company size once, then answers all product questions tailored to that size"

variables:
   # Shared across both topics.
   # Default 0 = "not yet collected".
   # Once set to any positive value the context_gate topic is left
   # behind permanently and will never be re-entered.
   number_of_employees: mutable number = 0
      description: "Number of employees in the user's company, used to personalise every product answer"

system:
   messages:
      welcome: "Hi! I'm your product advisor. What would you like to know?"
      error: "Sorry, something went wrong. Please try again."

   instructions: >
      You are a knowledgeable product advisor.
      Answer product questions accurately and concisely.
      Always tailor recommendations to the user's company size:
        - Small business  (fewer than 50 employees) : ease of setup, low cost, self-service features.
        - Mid-market      (50 – 500 employees)       : team collaboration, integrations, admin controls.
        - Enterprise      (more than 500 employees)  : security, SLAs, dedicated support, scalability.

# ── Topic 1: Gate ──────────────────────────────────────────────────────────────
# Entry point. Asks for company size and transitions away the moment it is given.
# It never answers a product question — that is entirely the job of product_advisor.
start_agent context_gate:
   description: "Intercepts the first message, collects company size, then hands off to the product advisor"

   reasoning:
      instructions:|
         The user has just sent a message.
         Do NOT answer their product question here.
         Respond with exactly this:
           "Before I answer, could you quickly tell me how many employees
            your company has? This helps me give you the most relevant
            recommendation."
         Wait for their answer, then call collect_employee_count.

      actions:
         # Stores the employee count AND immediately transitions to product_advisor.
         # The 'transition to' suffix fires after the variable is written,
         # so product_advisor receives control in the very same turn —
         # no extra round-trip, no intermediate agent response.
         collect_employee_count: @utils.setVariables
            with number_of_employees=...
            transition to @topic.product_advisor

# ── Topic 2: Advisor ───────────────────────────────────────────────────────────
# Permanent home for the rest of the conversation.
# number_of_employees is already populated when this topic is entered.
topic product_advisor:
   description: "Answers product questions personalised to the user's company size"

   reasoning:
      instructions:->
         | You are a product advisor.
           Company size: {!@variables.number_of_employees} employees.

           Tailor every answer to their company size:
           - Fewer than 50   → ease of setup, affordability, self-service features
           - 50 to 500       → team collaboration, integrations, admin controls
           - More than 500   → enterprise security, SLAs, dedicated support, scalability

           You have just received control from the context_gate topic.
           The user asked a product question before you had their company size.
           Look back at the conversation, find their original unanswered question,
           and answer it now — incorporating the {!@variables.number_of_employees}-employee context.

           For all follow-up questions in this session, answer directly.
           Never ask for company size again — it is already stored.
