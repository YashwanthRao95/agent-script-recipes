# ContextualProductAdvisor - Pre-flight Context Collection
# Demonstrates the "intercept-then-answer" pattern:
#
#   When the user sends their first message, the agent does NOT answer
#   immediately. Instead it collects one key piece of context
#   (number of employees) and only then answers the original question —
#   and every subsequent question — with that context baked in.
#
# Why this pattern?
#   Some answers differ significantly depending on the customer profile.
#   Collecting company size once at the start lets the agent give
#   consistently relevant, personalised responses without ever asking again.
#
# Key mechanics:
#   1. A single mutable variable tracks whether context has been collected.
#   2. The 'available when' guard on collect_employee_count ensures the
#      action is offered exactly once (while the value is still 0).
#   3. The instructions block has two clear states — "not collected" and
#      "collected" — so the LLM always knows what it should do next.
#   4. The LLM uses conversation history to recall the user's original
#      question and answer it after the context is provided.

config:
   agent_name: "ContextualProductAdvisor"
   agent_label: "ContextualProductAdvisor"
   agent_type: "AgentforceEmployeeAgent"
   description: "Answers product questions tailored to company size, collected once before the first answer"

variables:
   # The only piece of context we need up-front.
   # Default 0 = "not yet collected".  Once set to any positive value,
   # the collect_employee_count action is gated out permanently.
   number_of_employees: mutable number = 0
      description: "Number of employees in the user's company, used to personalise every product answer"

system:
   messages:
      welcome: "Hi! I'm your product advisor. What would you like to know?"
      error: "Sorry, something went wrong. Please try again."

   instructions: >
      You are a knowledgeable product advisor.
      Answer product questions accurately and concisely.
      Always tailor your recommendations to the user's company size:
        - Small business  (fewer than 50 employees) : ease of setup, low cost, self-service features.
        - Mid-market      (50 – 500 employees)       : team collaboration, integrations, admin controls.
        - Enterprise      (more than 500 employees)  : security, SLAs, dedicated support, scalability.

start_agent product_advisor:
   description: "Answers product questions, first collecting company size to personalise every response"

   reasoning:
      instructions:->
         |
           You are a product advisor. Help the user with their product questions.

           === Company context ===
         if @variables.number_of_employees == 0:
            |
              Company size: NOT YET KNOWN

              The user has just sent a message.
              Do NOT answer their product question yet.
              Instead, respond with exactly this:
                "Before I answer, could you quickly tell me how many employees
                 your company has? This helps me give you the most relevant
                 recommendation."

              Wait for their answer, then call collect_employee_count.
         else:
            |
              Company size: {!@variables.number_of_employees} employees

              Use this company size to personalise every answer:
                - Fewer than 50   → ease of setup, affordability, self-service
                - 50 to 500       → collaboration tools, integrations, admin controls
                - More than 500   → enterprise security, SLAs, dedicated support, scalability

              If the user's first question was never answered because you
              interrupted to collect company size, answer it now using the
              company-size context above.

              For all future questions in this conversation, answer directly —
              never ask for company size again, it is already stored.

      actions:
         # ── Context collector ──────────────────────────────────────────────────
         # 'available when' gates this action to fire ONLY while employee count
         # is still unknown.  Once the user supplies a number, the condition
         # becomes false and this action is never triggered again — so the
         # question is asked exactly once, no matter how long the chat runs.
         collect_employee_count: @utils.setVariables
            available when @variables.number_of_employees == 0
            with number_of_employees=...
